CREATE TABLE landscape(ark__id integer PRIMARY KEY, ark__parentid integer, ark__name_fr varchar(100), ark__name_de varchar(100), ark__desc varchar(100), node_path ltree);
CREATE UNIQUE INDEX idx_landscape_node_path_btree_idx ON landscape USING btree(node_path);
CREATE INDEX idx_landscape_node_path_gist_idx ON landscape USING gist(node_path);

CREATE OR REPLACE FUNCTION get_calculated_ark__node_path(param_ark__id integer)
 RETURNS ltree AS
$$
SELECT CASE WHEN p.ark__parentid IS NULL THEN p.ark__id::text::ltree
 ELSE get_calculated_ark__node_path(p.ark__parentid) || p.ark__id::text END
  FROM landscape As p
  WHERE p.ark__id = $1;
$$
  LANGUAGE sql;

CREATE OR REPLACE FUNCTION trig_update_ark__node_path() RETURNS trigger AS
$$
BEGIN
  IF TG_OP = 'UPDATE' THEN
        IF (COALESCE(OLD.ark__parentid,0) != COALESCE(NEW.ark__parentid,0)  OR  NEW.ark__id != OLD.ark__id) THEN
            UPDATE landscape SET node_path = get_calculated_ark__node_path(ark__id) 
                WHERE OLD.node_path  @> landscape.node_path;
        END IF;
  ELSIF TG_OP = 'INSERT' THEN
        UPDATE landscape SET node_path = get_calculated_ark__node_path(NEW.ark__id) WHERE landscape.ark__id = NEW.ark__id;
  END IF;
  
  RETURN NEW;
END
$$
LANGUAGE 'plpgsql' VOLATILE;

CREATE TRIGGER trig01_update_ark__node_path AFTER INSERT OR UPDATE 
   ON landscape FOR EACH ROW
   EXECUTE PROCEDURE trig_update_ark__node_path();

INSERT INTO landscape (ark__id, ark__parentid, ark__name_fr, ark__name_de, ark__desc )
	VALUES
	(1, NULL, 'Diagnostic négatif', 'Ergebnislose Bohrung', ''),(2, 2, '', '', ''),(3, NULL, 'Analyses', 'Analysen', ''),(4, 3, '14C', '14C', ''),(5, 4, 'Non renseigné', 'Nicht dokumentiert', ''),(6, 5, '', '', ''),(7, 4, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(8, 7, '', '', ''),(9, 4, 'Intrasite', 'In einer Fundstelle', ''),(10, 9, '', '', ''),(11, 3, 'Anthracologie', 'Anthrakologie', ''),(12, 11, 'Non renseigné', 'Nicht dokumentiert', ''),(13, 12, '', '', ''),(14, 11, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(15, 14, '', '', ''),(16, 11, 'Intrasite', 'In einer Fundstelle', ''),(17, 16, '', '', ''),(18, 3, 'Anthropologie', 'Anthropologie', ''),(19, 18, 'Non renseigné', 'Nicht dokumentiert', ''),(20, 19, '', '', ''),(21, 18, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(22, 21, '', '', ''),(23, 18, 'Intrasite', 'In einer Fundstelle', ''),(24, 23, '', '', ''),(25, 3, 'Carpologie', 'Karpologie', ''),(26, 25, 'Non renseigné', 'Nicht dokumentiert', ''),(27, 26, '', '', ''),(28, 25, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(29, 28, '', '', ''),(30, 25, 'Intrasite', 'In einer Fundstelle', ''),(31, 30, '', '', ''),(32, 3, 'Dendrochronologie', 'Dendrochronologie', ''),(33, 32, 'Non renseigné', 'Nicht dokumentiert', ''),(34, 33, '', '', ''),(35, 32, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(36, 35, '', '', ''),(37, 32, 'Intrasite', 'In einer Fundstelle', ''),(38, 37, '', '', ''),(39, 3, 'Entomologie', 'Entomologie', ''),(40, 39, 'Non renseigné', 'Nicht dokumentiert', ''),(41, 40, '', '', ''),(42, 39, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(43, 42, '', '', ''),(44, 39, 'Intrasite', 'In einer Fundstelle', ''),(45, 44, '', '', ''),(46, 3, 'Faune', 'Fauna', ''),(47, 46, 'Non renseigné', 'Nicht dokumentiert', ''),(48, 47, '', '', ''),(49, 46, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(50, 49, '', '', ''),(51, 46, 'Intrasite', 'In einer Fundstelle', ''),(52, 51, '', '', ''),(53, 3, 'Malacofaune', 'Malacofauna', ''),(54, 53, 'Non renseigné', 'Nicht dokumentiert', ''),(55, 54, '', '', ''),(56, 53, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(57, 56, '', '', ''),(58, 53, 'Intrasite', 'In einer Fundstelle', ''),(59, 58, '', '', ''),(60, 3, 'Paléomagnetisme', 'Paläomagnetik', ''),(61, 60, 'Non renseigné', 'Nicht dokumentiert', ''),(62, 61, '', '', ''),(63, 60, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(64, 63, '', '', ''),(65, 60, 'Intrasite', 'In einer Fundstelle', ''),(66, 65, '', '', ''),(67, 3, 'Palynologie', 'Palynologie', ''),(68, 67, 'Non renseigné', 'Nicht dokumentiert', ''),(69, 68, '', '', ''),(70, 67, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(71, 70, '', '', ''),(72, 67, 'Intrasite', 'In einer Fundstelle', ''),(73, 72, '', '', ''),(74, 3, 'Percolation des vases', 'Perkolation der Keramik', ''),(75, 74, 'Non renseigné', 'Nicht dokumentiert', ''),(76, 75, '', '', ''),(77, 74, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(78, 77, '', '', ''),(79, 74, 'Intrasite', 'In einer Fundstelle', ''),(80, 79, '', '', ''),(81, 3, 'Phytolithes', 'Phytolithes', ''),(82, 81, 'Non renseigné', 'Nicht dokumentiert', ''),(83, 82, '', '', ''),(84, 81, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(85, 84, '', '', ''),(86, 81, 'Intrasite', 'In einer Fundstelle', ''),(87, 86, '', '', ''),(88, NULL, 'Formation superficielle', 'Boden', ''),(89, 88, 'Analyses', 'Analysen', ''),(90, 89, 'Non renseigné', 'Nicht dokumentiert', ''),(91, 90, 'Non renseigné', 'Nicht dokumentiert"', ''),(92, 90, 'Extrasite', 'Ausserhalb einer Fundstelle"', ''),(93, 90, 'Intrasite', 'In einer Fundstelle"', ''),(94, 89, 'Autres', 'Andere', ''),(95, 94, 'Non renseigné', 'Nicht dokumentiert"', ''),(96, 94, 'Extrasite', 'Ausserhalb einer Fundstelle"', ''),(97, 94, 'Intrasite', 'In einer Fundstelle"', ''),(98, 89, 'Granulométrie', 'Korngrößenverteilung', ''),(99, 98, 'Non renseigné', 'Nicht dokumentiert"', ''),(100, 98, 'Extrasite', 'Ausserhalb einer Fundstelle"', ''),(101, 98, 'Intrasite', 'In einer Fundstelle"', ''),(102, 89, 'Hydrologie', 'Hydrologie', ''),(103, 102, 'Non renseigné', 'Nicht dokumentiert"', ''),(104, 102, 'Extrasite', 'Ausserhalb einer Fundstelle"', ''),(105, 102, 'Intrasite', 'In einer Fundstelle"', ''),(106, 89, 'Pédologie', 'Pedologie', ''),(107, 106, 'Non renseigné', 'Nicht dokumentiert"', ''),(108, 106, 'Extrasite', 'Ausserhalb einer Fundstelle"', ''),(109, 106, 'Intrasite', 'In einer Fundstelle"', ''),(110, 89, 'Phosphates', 'Phosphaten', ''),(111, 110, 'Non renseigné', 'Nicht dokumentiert"', ''),(112, 110, 'Extrasite', 'Ausserhalb einer Fundstelle"', ''),(113, 110, 'Intrasite', 'In einer Fundstelle"', ''),(114, 88, 'Paléochenal daté', 'Datierte Paläofahrrinne', ''),(115, 114, 'Non renseigné', 'Nicht dokumentiert', ''),(116, 115, '', '', ''),(117, 114, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(118, 117, '', '', ''),(119, 114, 'Intrasite', 'In einer Fundstelle', ''),(120, 119, '', '', ''),(121, 88, 'Paléosol', 'Paläoboden', ''),(122, 121, 'Non renseigné', 'Nicht dokumentiert', ''),(123, 122, '', '', ''),(124, 121, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(125, 124, '', '', ''),(126, 121, 'Intrasite', 'In einer Fundstelle', ''),(127, 126, '', '', ''),(128, 88, 'Petrologie', 'Petrologie', ''),(129, 128, 'Non renseigné', 'Nicht dokumentiert', ''),(130, 129, '', '', ''),(131, 128, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(132, 131, '', '', ''),(133, 128, 'Intrasite', 'In einer Fundstelle', ''),(134, 133, '', '', ''),(135, 88, 'Sédimentologie', 'Sedimentologie', ''),(136, 135, 'Non renseigné', 'Nicht dokumentiert', ''),(137, 136, '', '', ''),(138, 135, 'Extrasite', 'Ausserhalb einer Fundstelle', ''),(139, 138, '', '', ''),(140, 135, 'Intrasite', 'In einer Fundstelle', ''),(141, 140, '', '', ''),(142, NULL, 'Structure agraire', 'Agrar', ''),(143, 142, 'Indéterminé', 'Unbestimmt', ''),(144, 140, '', '', ''),(145, 142, 'Crêtes de labours_Ackerberg', 'Ackerberg', ''),(146, 140, '', '', ''),(147, 142, 'Champ bombé', 'Wölbacker', ''),(148, 140, '', '', ''),(149, 142, 'Enclos', 'Schanze', ''),(150, 140, '', '', ''),(151, 142, 'Muret', 'Trennmauer', ''),(152, 140, '', '', ''),(153, 142, 'Murger_Steinrudel', 'Steinrudel ', ''),(154, 153, 'Non renseigné', 'Nicht dokumentiert', ''),(155, 154, '', '', ''),(156, 153, 'Autres', 'Andere', ''),(157, 156, '', '', ''),(158, 153, 'Calcaire', 'Kalk', ''),(159, 158, '', '', ''),(160, 153, 'Gneiss', 'Gneis', ''),(161, 160, '', '', ''),(162, 153, 'Granite', 'Granit', ''),(163, 162, '', '', ''),(164, 153, 'Grès', 'Sandstein', ''),(165, 164, '', '', ''),(166, 142, 'Parcellaire fossile', 'Altflur', ''),(167, 164, '', '', ''),(168, 142, 'Rideau de culture', 'Terrassen Raine', ''),(169, 164, '', '', ''),(170, 142, 'Terrasse agricole', 'Ackerterrasse', ''),(171, 164, '', '', '');