CREATE TABLE ark_realestate(re_id integer PRIMARY KEY, re_parentid integer, re_name varchar(100), node_path ltree);
CREATE UNIQUE INDEX idx_ark_realestate_node_path_btree_idx ON ark_realestate USING btree(node_path);
CREATE INDEX idx_ark_realestate_node_path_gist_idx ON ark_realestate USING gist(node_path);

CREATE OR REPLACE FUNCTION get_calculated_re_node_path(param_re_id integer)
 RETURNS ltree AS
$$
SELECT CASE WHEN p.re_parentid IS NULL THEN p.re_id::text::ltree
 ELSE get_calculated_re_node_path(p.re_parentid) || p.re_id::text END
  FROM ark_realestate As p
  WHERE p.re_id = $1;
$$
  LANGUAGE sql;

CREATE OR REPLACE FUNCTION trig_update_re_node_path() RETURNS trigger AS
$$
BEGIN
  IF TG_OP = 'UPDATE' THEN
        IF (COALESCE(OLD.re_parentid,0) != COALESCE(NEW.re_parentid,0)  OR  NEW.re_id != OLD.re_id) THEN
            UPDATE ark_realestate SET node_path = get_calculated_re_node_path(re_id) 
                WHERE OLD.node_path  @> ark_realestate.node_path;
        END IF;
  ELSIF TG_OP = 'INSERT' THEN
        UPDATE ark_realestate SET node_path = get_calculated_re_node_path(NEW.re_id) WHERE ark_realestate.re_id = NEW.re_id;
  END IF;
  
  RETURN NEW;
END
$$
LANGUAGE 'plpgsql' VOLATILE;

CREATE TRIGGER trig01_update_re_node_path AFTER INSERT OR UPDATE 
   ON ark_realestate FOR EACH ROW
   EXECUTE PROCEDURE trig_update_re_node_path();

INSERT INTO ark_realestate (re_id, re_parentid, re_name)
	VALUES
	(1, NULL, 'Habitat'),(2, 1, 'Indéterminé'),(3, 2, 'Non renseigné'),(4, 2, 'Fosse'),(5, 2, 'Fossé'),(6, 1, 'Non renseigné'),(7, 6, 'Non déterminé'),(8, 6, 'Camp militaire'),(9, 6, 'Ferme'),(10, 6, 'Villa'),(11, 6, 'Village hameau'),(12, 6, 'Château'),(13, 1, 'Fortifié'),(14, 13, 'Non renseigné'),(15, 13, 'Camp militaire'),(16, 13, 'Ferme'),(17, 13, 'Villa'),(18, 13, 'Village hameau'),(19, 13, 'Château'),(20, 1, 'Enclos'),(21, 20, 'Non renseigné'),(22, 20, 'Camp militaire'),(23, 20, 'Ferme'),(24, 20, 'Villa'),(25, 20, 'Village hameau'),(26, 20, 'Château'),(27, 1, 'Ouvert'),(28, 27, 'Non renseigné'),(29, 27, 'Camp militaire'),(30, 27, 'Ferme'),(31, 27, 'Villa'),(32, 27, 'Village hameau'),(33, 27, 'Château'),(34, 1, 'Groupé'),(35, 34, 'Non renseigné'),(36, 34, 'Camp militaire'),(37, 34, 'Ferme'),(38, 34, 'Villa'),(39, 34, 'Village hameau'),(40, 34, 'Château'),(41, 1, 'Isolé'),(42, 41, 'Non renseigné'),(43, 41, 'Camp militaire'),(44, 41, 'Ferme'),(45, 41, 'Villa'),(46, 41, 'Village hameau'),(47, 41, 'Château'),(48, NULL, 'Funéraire'),(49, 48, 'Indéterminé'),(50, 49, 'Non renseigné'),(51, 50, 'Architecture de bois'),(52, 50, 'Architecture de pierre'),(53, 50, 'Enclos sépulcral'),(54, 49, 'Inhumation'),(55, 54, 'Architecture de bois'),(56, 54, 'Architecture de pierre'),(57, 54, 'Enclos sépulcral'),(58, 49, 'Incinération'),(59, 58, 'Architecture de bois'),(60, 58, 'Architecture de pierre'),(61, 58, 'Enclos sépulcral'),(62, 49, 'Les deux'),(63, 62, 'Architecture de bois'),(64, 62, 'Architecture de pierre'),(65, 62, 'Enclos sépulcral'),(66, 48, 'Enclos Funéraire'),(67, 66, 'Non renseigné'),(68, 67, 'Tombe de grand module'),(69, 67, 'Architecture de bois'),(70, 67, 'Architecture de pierre'),(71, 67, 'Enclos sépulcral'),(72, 66, 'Inhumation'),(73, 72, 'Tombe de grand module'),(74, 72, 'Architecture de bois'),(75, 72, 'Architecture de pierre'),(76, 72, 'Enclos sépulcral'),(77, 66, 'Incinération'),(78, 77, 'Tombe de grand module'),(79, 77, 'Architecture de bois'),(80, 77, 'Architecture de pierre'),(81, 77, 'Enclos sépulcral'),(82, 66, 'Les deux'),(83, 82, 'Tombe de grand module'),(84, 82, 'Architecture de bois'),(85, 82, 'Architecture de pierre'),(86, 82, 'Enclos sépulcral'),(87, 48, 'Tombe plate isolée'),(88, 87, 'Non renseigné'),(89, 88, 'Architecture de bois'),(90, 88, 'Architecture de pierre'),(91, 88, 'Enclos sépulcral'),(92, 87, 'Inhumation'),(93, 92, 'Architecture de bois'),(94, 92, 'Architecture de pierre'),(95, 92, 'Enclos sépulcral'),(96, 87, 'Incinération'),(97, 96, 'Architecture de bois'),(98, 96, 'Architecture de pierre'),(99, 96, 'Enclos sépulcral'),(100, 87, 'Les deux'),(101, 100, 'Architecture de bois'),(102, 100, 'Architecture de pierre'),(103, 100, 'Enclos sépulcral'),(104, 48, 'Tumulus isolé'),(105, 104, 'Non renseigné'),(106, 105, 'Tombe de grand module'),(107, 105, 'Architecture de bois'),(108, 105, 'Architecture de pierre'),(109, 105, 'Enclos sépulcral'),(110, 104, 'Inhumation'),(111, 110, 'Tombe de grand module'),(112, 110, 'Architecture de bois'),(113, 110, 'Architecture de pierre'),(114, 110, 'Enclos sépulcral'),(115, 104, 'Incinération'),(116, 115, 'Tombe de grand module'),(117, 115, 'Architecture de bois'),(118, 115, 'Architecture de pierre'),(119, 115, 'Enclos sépulcral'),(120, 104, 'Les deux'),(121, 120, 'Tombe de grand module'),(122, 120, 'Architecture de bois'),(123, 120, 'Architecture de pierre'),(124, 120, 'Enclos sépulcral'),(125, 48, 'Nécropole tumulaire'),(126, 125, 'Non renseigné'),(127, 126, 'Tombe de grand module'),(128, 126, 'Architecture de bois'),(129, 126, 'Architecture de pierre'),(130, 126, 'Enclos sépulcral'),(131, 125, 'Inhumation'),(132, 131, 'Tombe de grand module'),(133, 131, 'Architecture de bois'),(134, 131, 'Architecture de pierre'),(135, 131, 'Enclos sépulcral'),(136, 125, 'Incinération'),(137, 136, 'Tombe de grand module'),(138, 136, 'Architecture de bois'),(139, 136, 'Architecture de pierre'),(140, 136, 'Enclos sépulcral'),(141, 125, 'Les deux'),(142, 141, 'Tombe de grand module'),(143, 141, 'Architecture de bois'),(144, 141, 'Architecture de pierre'),(145, 141, 'Enclos sépulcral'),(146, 48, 'Nécropole tombes plates'),(147, 146, 'Non renseigné'),(148, 147, 'Architecture de bois'),(149, 147, 'Architecture de pierre'),(150, 147, 'Enclos sépulcral'),(151, 146, 'Inhumation'),(152, 151, 'Architecture de bois'),(153, 151, 'Architecture de pierre'),(154, 151, 'Enclos sépulcral'),(155, 146, 'Incinération'),(156, 155, 'Architecture de bois'),(157, 155, 'Architecture de pierre'),(158, 155, 'Enclos sépulcral'),(159, 146, 'Les deux'),(160, 159, 'Architecture de bois'),(161, 159, 'Architecture de pierre'),(162, 159, 'Enclos sépulcral'),(163, NULL, 'Isolé'),(164, 163, 'Dépot'),(165, 164, 'Inscription'),(166, 164, 'Non-inscrit'),(167, 164, 'Figuré'),(168, 163, 'Bloc architectural'),(169, 168, 'Inscription'),(170, 168, 'Non-inscrit'),(171, 168, 'Figuré'),(172, 163, 'Statuaire'),(173, 172, 'Inscription'),(174, 172, 'Non-inscrit'),(175, 172, 'Figuré'),(176, 163, 'Stèle'),(177, 176, 'Inscription'),(178, 176, 'Non-inscrit'),(179, 176, 'Figuré'),(180, NULL, 'Rituel'),(181, 180, 'Indéterminé'),(182, 181, 'Association de mobiliers'),(183, 181, 'Vases miniatures'),(184, 181, 'Rouelles'),(185, 181, 'Jetons'),(186, 181, 'Ossements humains'),(187, 181, 'Ossements animaux'),(188, 181, 'Armes mutilée'),(189, 181, 'Statuette'),(190, 180, 'Temple'),(191, 190, 'Association de mobiliers'),(192, 190, 'Vases miniatures'),(193, 190, 'Rouelles'),(194, 190, 'Jetons'),(195, 190, 'Ossements humains'),(196, 190, 'Ossements animaux'),(197, 190, 'Armes mutilée'),(198, 190, 'Statuette'),(199, 180, 'Source'),(200, 199, 'Association de mobiliers'),(201, 199, 'Vases miniatures'),(202, 199, 'Rouelles'),(203, 199, 'Jetons'),(204, 199, 'Ossements humains'),(205, 199, 'Ossements animaux'),(206, 199, 'Armes mutilée'),(207, 199, 'Statuette'),(208, 180, 'Fanum'),(209, 208, 'Association de mobiliers'),(210, 208, 'Vases miniatures'),(211, 208, 'Rouelles'),(212, 208, 'Jetons'),(213, 208, 'Ossements humains'),(214, 208, 'Ossements animaux'),(215, 208, 'Armes mutilée'),(216, 208, 'Statuette'),(217, 180, 'Puits'),(218, 217, 'Association de mobiliers'),(219, 217, 'Vases miniatures'),(220, 217, 'Rouelles'),(221, 217, 'Jetons'),(222, 217, 'Ossements humains'),(223, 217, 'Ossements animaux'),(224, 217, 'Armes mutilée'),(225, 217, 'Statuette'),(226, 180, 'Grotte'),(227, 226, 'Association de mobiliers'),(228, 226, 'Vases miniatures'),(229, 226, 'Rouelles'),(230, 226, 'Jetons'),(231, 226, 'Ossements humains'),(232, 226, 'Ossements animaux'),(233, 226, 'Armes mutilée'),(234, 226, 'Statuette'),(235, 180, 'Dans l’habitat'),(236, 235, 'Association de mobiliers'),(237, 235, 'Vases miniatures'),(238, 235, 'Rouelles'),(239, 235, 'Jetons'),(240, 235, 'Ossements humains'),(241, 235, 'Ossements animaux'),(242, 235, 'Armes mutilée'),(243, 235, 'Statuette'),(244, 180, 'Isolé'),(245, 244, 'Association de mobiliers'),(246, 244, 'Vases miniatures'),(247, 244, 'Rouelles'),(248, 244, 'Jetons'),(249, 244, 'Ossements humains'),(250, 244, 'Ossements animaux'),(251, 244, 'Armes mutilée'),(252, 244, 'Statuette'),(253, 180, 'Eglise'),(254, 253, 'Association de mobiliers'),(255, 253, 'Vases miniatures'),(256, 253, 'Rouelles'),(257, 253, 'Jetons'),(258, 253, 'Ossements humains'),(259, 253, 'Ossements animaux'),(260, 253, 'Armes mutilée'),(261, 253, 'Statuette'),(262, 180, 'Abbaye'),(263, 262, 'Association de mobiliers'),(264, 262, 'Vases miniatures'),(265, 262, 'Rouelles'),(266, 262, 'Jetons'),(267, 262, 'Ossements humains'),(268, 262, 'Ossements animaux'),(269, 262, 'Armes mutilée'),(270, 262, 'Statuette'),(271, NULL, 'Voie'),(272, 271, 'Gué'),(273, 272, 'Quai'),(274, 272, 'Aménagement de berge'),(275, 272, 'Pente aménagée'),(276, 271, 'Pont'),(277, 276, 'Quai'),(278, 276, 'Aménagement de berge'),(279, 276, 'Pente aménagée'),(280, 271, 'Borne'),(281, 280, 'Quai'),(282, 280, 'Aménagement de berge'),(283, 280, 'Pente aménagée'),(284, NULL, 'Structure agraire'),(285, 284, 'Enclos'),(286, 284, 'Champ bombé'),(287, 284, 'Terrasse agricole'),(288, 284, 'Murger'),(289, 284, 'Crêtes de labours');