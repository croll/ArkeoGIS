CREATE TABLE ark_furniture(fu_id integer PRIMARY KEY, fu_parentid integer, fu_name_fr varchar(100), fu_name_de varchar(100), fu_desc varchar(100), node_path ltree);
CREATE UNIQUE INDEX idx_ark_furniture_node_path_btree_idx ON ark_furniture USING btree(node_path);
CREATE INDEX idx_ark_furniture_node_path_gist_idx ON ark_furniture USING gist(node_path);

CREATE OR REPLACE FUNCTION get_calculated_fu_node_path(param_fu_id integer)
 RETURNS ltree AS
$$
SELECT CASE WHEN p.fu_parentid IS NULL THEN p.fu_id::text::ltree
 ELSE get_calculated_fu_node_path(p.fu_parentid) || p.fu_id::text END
  FROM ark_furniture As p
  WHERE p.fu_id = $1;
$$
  LANGUAGE sql;

CREATE OR REPLACE FUNCTION trig_update_fu_node_path() RETURNS trigger AS
$$
BEGIN
  IF TG_OP = 'UPDATE' THEN
        IF (COALESCE(OLD.fu_parentid,0) != COALESCE(NEW.fu_parentid,0)  OR  NEW.fu_id != OLD.fu_id) THEN
            UPDATE ark_furniture SET node_path = get_calculated_fu_node_path(fu_id) 
                WHERE OLD.node_path  @> ark_furniture.node_path;
        END IF;
  ELSIF TG_OP = 'INSERT' THEN
        UPDATE ark_furniture SET node_path = get_calculated_fu_node_path(NEW.fu_id) WHERE ark_furniture.fu_id = NEW.fu_id;
  END IF;
  
  RETURN NEW;
END
$$
LANGUAGE 'plpgsql' VOLATILE;

CREATE TRIGGER trig01_update_fu_node_path AFTER INSERT OR UPDATE 
   ON ark_furniture FOR EACH ROW
   EXECUTE PROCEDURE trig_update_fu_node_path();

INSERT INTO ark_furniture (fu_id, fu_parentid, fu_name_fr, fu_name_de, fu_desc )
	VALUES
	(1, NULL, 'Céramique', 'Keramik', ''),(2, 1, 'Conteneur', 'Behälter', ''),(3, 2, 'Amphore', 'Amphore', ''),(4, 2, 'Dolium', 'Dolium', ''),(5, 2, 'Autres', 'Anderes', ''),(6, 1, 'Vaisselle', 'Feinkeramik', ''),(7, 6, 'Cruche', 'Krug', ''),(8, 7, 'Import', 'Importware', ''),(9, 7, 'Locale', 'Lokale Ware', ''),(10, 7, 'Les deux', 'Beide', ''),(11, 6, 'Coupe', 'Schüssel', ''),(12, 11, 'Import', 'Importware', ''),(13, 11, 'Locale', 'Lokale Ware', ''),(14, 11, 'Les deux', 'Beide', ''),(15, 6, 'Urne', 'Urne', ''),(16, 15, 'Import', 'Importware', ''),(17, 15, 'Locale', 'Lokale Ware', ''),(18, 15, 'Les deux', 'Beide', ''),(19, 6, 'Bouteille', 'Flasche', ''),(20, 19, 'Import', 'Importware', ''),(21, 19, 'Locale', 'Lokale Ware', ''),(22, 19, 'Les deux', 'Beide', ''),(23, 6, 'Couvercle', 'Deckel', ''),(24, 23, 'Import', 'Importware', ''),(25, 23, 'Locale', 'Lokale Ware', ''),(26, 23, 'Les deux', 'Beide', ''),(27, 6, 'Passoire', 'Sieb', ''),(28, 27, 'Import', 'Importware', ''),(29, 27, 'Locale', 'Lokale Ware', ''),(30, 27, 'Les deux', 'Beide', ''),(31, 6, 'Entonnoir', 'Trichter', ''),(32, 31, 'Import', 'Importware', ''),(33, 31, 'Locale', 'Lokale Ware', ''),(34, 31, 'Les deux', 'Beide', ''),(35, 6, 'Mortier', 'Mörser', ''),(36, 35, 'Import', 'Importware', ''),(37, 35, 'Locale', 'Lokale Ware', ''),(38, 35, 'Les deux', 'Beide', ''),(39, 6, 'Tasse', 'Tasse', ''),(40, 39, 'Import', 'Importware', ''),(41, 39, 'Locale', 'Lokale Ware', ''),(42, 39, 'Les deux', 'Beide', ''),(43, 6, 'Assiette', 'Teller', ''),(44, 43, 'Import', 'Importware', ''),(45, 43, 'Locale', 'Lokale Ware', ''),(46, 43, 'Les deux', 'Beide', ''),(47, 6, 'Microvase', 'Miniaturgefässe', ''),(48, 47, 'Import', 'Importware', ''),(49, 47, 'Locale', 'Lokale Ware', ''),(50, 47, 'Les deux', 'Beide', ''),(51, 6, 'Autres', 'Anderes', ''),(52, 51, 'Import', 'Importware', ''),(53, 51, 'Locale', 'Lokale Ware', ''),(54, 51, 'Les deux', 'Beide', ''),(55, 6, 'Non renseigné', 'Nicht dokumentiert', ''),(56, 55, 'Import', 'Importware', ''),(57, 55, 'Locale', 'Lokale Ware', ''),(58, 55, 'Les deux', 'Beide', ''),(59, 1, 'Urne funéraire', 'Graburne', ''),(60, 1, 'Terres cuites architecturales', 'Baumaterial', ''),(61, 60, 'Tuile', 'Ziegel', ''),(62, 61, 'Inscription', 'Inschrift', ''),(63, 60, 'Hypocauste', 'Hypocaust', ''),(64, 63, 'Inscription', 'Inschrift', ''),(65, 60, 'Cloison', 'Trennwand', ''),(66, 65, 'Inscription', 'Inschrift', ''),(67, 60, 'Brique', 'Backstein', ''),(68, 67, 'Inscription', 'Inschrift', ''),(69, 60, 'Autres', 'Anderes', ''),(70, 69, 'Inscription', 'Inschrift', ''),(71, 69, 'Pots de poêle', 'Ofentopf', ''),(72, 69, 'Carreaux de poêle', 'Kachelofen', ''),(73, 1, 'Autres', 'Anderes', ''),(74, 73, 'Statuette', 'Figur', ''),(75, 73, 'Lampe', 'Lampe', ''),(76, 73, 'Textile', 'Textil', ''),(77, 73, 'Parure', 'Schmuck', ''),(78, 73, 'Jeux', 'Spiele', ''),(79, 73, 'Jetons', 'Spielstein', ''),(80, 73, 'Chenet', 'Feuerbock', ''),(81, 73, 'Balle de fronde', 'Schleuderstein', ''),(82, 73, 'Creuset', 'Tiegel', ''),(83, 73, 'Briquetage', 'Briquetage', ''),(84, 73, 'Brûle-parfum', 'Räucherfass', ''),(85, NULL, 'Métal', 'Metall', ''),(86, 85, 'Armement', 'Waffen Rüstungen', ''),(87, 86, 'Casque', 'Helm', ''),(88, 86, 'Epée', 'Schwert', ''),(89, 86, 'Lance', 'Lanze', ''),(90, 86, 'Bouclier', 'Schild', ''),(91, 86, 'Cuirasse', 'Panzer', ''),(92, 86, 'Hache', 'Axt', ''),(93, 86, 'Balle de fronde', 'Schleuderstein', ''),(94, 86, 'Pointe de flèche', 'Pfeilspitze', ''),(95, 86, 'Poignard', 'Dolch', ''),(96, 86, 'Autres', 'Anderes', ''),(97, 85, 'Vaisselle', 'Geschirr', ''),(98, 85, 'Harnachement', 'Pferdegeschirr', ''),(99, 98, 'Mors', 'Gebiss', ''),(100, 98, 'Passe-guides', 'Führungsring', ''),(101, 98, 'Hipposandale', 'Hufschuh', ''),(102, 98, 'Char', 'Wagen', ''),(103, 85, 'Monnaies', 'Münzen', ''),(104, 103, 'Or', 'Gold', ''),(105, 103, 'Argent', 'Silber', ''),(106, 103, 'Bronze', 'Bronze', ''),(107, 103, 'Potin', 'Potinmünze', ''),(108, 103, 'Electrum', 'Electrum', ''),(109, 103, 'Monnaie fourrée', 'Plattiert', ''),(110, 103, 'Fausse monnaie', 'Falschmünze', ''),(111, 103, 'Autres', 'Anderes', ''),(112, 85, 'Parure', 'Tracht', ''),(113, 112, 'Fibule', 'Fibel', ''),(114, 112, 'Epingle', 'Nadel', ''),(115, 112, 'Parure annulaire', 'Ringförmig', ''),(116, 115, 'Torque', 'Torques', ''),(117, 115, 'Bracelet', 'Armreif', ''),(118, 115, 'Anneau de cheville', 'Beinreif', ''),(119, 112, 'Ceinture', 'Gürtel', ''),(120, 112, 'Pendeloque', 'Gehänge', ''),(121, 112, 'Boucle d’oreille', 'Ohrring', ''),(122, 112, 'Autres', 'Anderes', ''),(123, 85, 'Autres', 'Anderes', ''),(124, 123, 'Lingots', 'Barren', ''),(125, 123, 'Scories', 'Schlacke ', ''),(126, 123, 'Statuette', 'Figur', ''),(127, 85, 'Outils', 'Werkzeug', ''),(128, 127, 'Faucille', 'Sense', ''),(129, 127, 'Marteau', 'Hammer', ''),(130, 127, 'Hache', 'Axt', ''),(131, 127, 'Couteau', 'Messer', ''),(132, 127, 'Forces', 'Schere', ''),(133, 127, 'Clous', 'Nagel', ''),(134, 127, 'Toilette', 'Toilettenbesteck', ''),(135, 127, 'Poids', 'Gewicht', ''),(136, 127, 'Burin', 'Meissel', ''),(137, 127, 'Autres', 'Anderes', ''),(138, NULL, 'Lithique', 'Stein', ''),(139, 138, 'Outils', 'Werkzeug', ''),(140, 139, 'Mouture', 'Mahlstein', ''),(141, 140, 'Grès', 'Sandstein', ''),(142, 140, 'Calcaire', 'Kalkstein', ''),(143, 140, 'Basalte', 'Basalt', ''),(144, 140, 'Rhyolite', 'Rhyolith', ''),(145, 140, 'Silex', 'Silex', ''),(146, 140, 'Autres', 'Anderes', ''),(147, 139, 'Hache', 'Axt', ''),(148, 147, 'Grès', 'Sandstein', ''),(149, 147, 'Calcaire', 'Kalkstein', ''),(150, 147, 'Basalte', 'Basalt', ''),(151, 147, 'Rhyolite', 'Rhyolith', ''),(152, 147, 'Silex', 'Silex', ''),(153, 147, 'Autres', 'Anderes', ''),(154, 139, 'Racloir', 'Kratzer', ''),(155, 154, 'Grès', 'Sandstein', ''),(156, 154, 'Calcaire', 'Kalkstein', ''),(157, 154, 'Basalte', 'Basalt', ''),(158, 154, 'Rhyolite', 'Rhyolith', ''),(159, 154, 'Silex', 'Silex', ''),(160, 154, 'Autres', 'Anderes', ''),(161, 139, 'Polissoir', 'Polierwerkzeug', ''),(162, 161, 'Grès', 'Sandstein', ''),(163, 161, 'Calcaire', 'Kalkstein', ''),(164, 161, 'Basalte', 'Basalt', ''),(165, 161, 'Rhyolite', 'Rhyolith', ''),(166, 161, 'Silex', 'Silex', ''),(167, 161, 'Autres', 'Anderes', ''),(168, 139, 'Autres', 'Anderes', ''),(169, 168, 'Grès', 'Sandstein', ''),(170, 168, 'Calcaire', 'Kalkstein', ''),(171, 168, 'Basalte', 'Basalt', ''),(172, 168, 'Rhyolite', 'Rhyolith', ''),(173, 168, 'Silex', 'Silex', ''),(174, 168, 'Autres', 'Anderes', ''),(175, 138, 'Armement', 'Waffen', ''),(176, 138, 'Bloc architectural', 'Baustein', ''),(177, 176, 'Grès', 'Sandstein', ''),(178, 177, 'Inscription', 'Inschrift', ''),(179, 177, 'Décor', 'Figürlich', ''),(180, 176, 'Calcaire', 'Kalkstein', ''),(181, 180, 'Inscription', 'Inschrift', ''),(182, 180, 'Décor', 'Figürlich', ''),(183, 176, 'Marbre', 'Marmor', ''),(184, 183, 'Inscription', 'Inschrift', ''),(185, 183, 'Décor', 'Figürlich', ''),(186, 176, 'Autres', 'Anderes', ''),(187, 186, 'Inscription', 'Inschrift', ''),(188, 186, 'Décor', 'Figürlich', ''),(189, 138, 'Mosaïque', 'Mosaik', ''),(190, 138, 'Statuaire', 'Statue', ''),(191, 190, 'Grès', 'Sandstein', ''),(192, 191, 'Inscription', 'Inschrift', ''),(193, 190, 'Calcaire', 'Kalkstein', ''),(194, 193, 'Inscription', 'Inschrift', ''),(195, 190, 'Marbre', 'Marmor', ''),(196, 195, 'Inscription', 'Inschrift', ''),(197, 190, 'Autres', 'Anderes', ''),(198, 197, 'Inscription', 'Inschrift', ''),(199, 138, 'Autres', 'Anderes', ''),(200, 199, 'Borne', 'Meilenstein', ''),(201, 200, 'Inscription', 'Inschrift', ''),(202, 199, 'Stèle', 'Stele', ''),(203, 202, 'Inscription', 'Inschrift', ''),(204, 199, 'Sarcophage', 'Sarkophag', ''),(205, 204, 'Inscription', 'Inschrift', ''),(206, NULL, 'Os', 'Knochen', ''),(207, 206, 'Ossements humains', 'Menschenknochen', ''),(208, 207, 'Tabletterie', 'Knochenschnitzerei', ''),(209, 207, 'Outils', 'Werkzeug', ''),(210, 207, 'Parure', 'Schmuck', ''),(211, 207, 'Autres', 'Anderes', ''),(212, 206, 'Ossements animaux', 'Tierknochen', ''),(213, 212, 'Tabletterie', 'Knochenschnitzerei', ''),(214, 212, 'Outils', 'Werkzeug', ''),(215, 212, 'Parure', 'Schmuck', ''),(216, 212, 'Autres', 'Anderes', ''),(217, 206, 'Indéterminé', 'Unbestimmt', ''),(218, 217, 'Tabletterie', 'Knochenschnitzerei', ''),(219, 217, 'Outils', 'Werkzeug', ''),(220, 217, 'Parure', 'Schmuck', ''),(221, 217, 'Autres', 'Anderes', ''),(222, NULL, 'Verre', 'Glas', ''),(223, 222, 'Parure', 'Schmuck', ''),(224, 223, 'Perle', 'Perle', ''),(225, 223, 'Bracelet', 'Armreifen', ''),(226, 222, 'Vaisselle', 'Geschirr', ''),(227, 222, 'Vitre', 'Fensterglas', ''),(228, 222, 'Autres', 'Anderes', ''),(229, NULL, 'Autres', 'Anderes', ''),(230, 229, 'Enduits', 'Putz', '');

ALTER TABLE ONLY ark_siteperiod_furniture
    ADD CONSTRAINT ark_siteperiod_furniture_sf_furniture_id_fkey FOREIGN KEY (sf_furniture_id) REFERENCES ark_furniture(fu_id) ON DELETE CASCADE;


